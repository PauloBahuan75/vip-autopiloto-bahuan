/***********************
 * VIP AUTOPILOTO - Bahuan Imóveis
 * Code.gs COMPLETO (corrigido)
 *
 * Endpoints:
 * - doPost: recebe JSON {type:"lead|wa_click|pageview", payload:{...}}
 * - doGet : fallback GET para registrar clique e testar visits
 *
 * Abas:
 * - Leads   (captura lead + score/status)
 * - CLICKS  (cliques para WhatsApp)
 * - VISITS  (visitas na landing /vip)
 * - Config  (email relatório)
 ***********************/

const TZ = 'America/Sao_Paulo';

const SHEET_LEADS  = 'Leads';
const SHEET_CLICKS = 'CLICKS';
const SHEET_VISITS = 'VISITS';
const SHEET_CONFIG = 'Config';

const PROP_SPREADSHEET_ID = 'SPREADSHEET_ID';

/** =======================
 *  1) UTILITÁRIOS BÁSICOS
 *  ======================= */
function json_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function parseBody_(e) {
  try {
    const raw = e && e.postData && e.postData.contents ? e.postData.contents : '';
    if (!raw) return {};
    return JSON.parse(raw);
  } catch (err) {
    return {};
  }
}

function getSpreadsheet_() {
  const id = PropertiesService.getScriptProperties().getProperty(PROP_SPREADSHEET_ID);
  if (id) return SpreadsheetApp.openById(id);
  return SpreadsheetApp.getActiveSpreadsheet();
}

function getOrCreateSheet_(ss, name, headers) {
  let sh = ss.getSheetByName(name);
  if (!sh) {
    sh = ss.insertSheet(name);
    sh.appendRow(headers);
    sh.getRange(1, 1, 1, headers.length).setFontWeight('bold');
  } else if (sh.getLastRow() === 0) {
    sh.appendRow(headers);
    sh.getRange(1, 1, 1, headers.length).setFontWeight('bold');
  }
  return sh;
}

function setupSheets_(ss) {
  getOrCreateSheet_(ss, SHEET_LEADS, [
    'Timestamp','Nome','WhatsApp','Bairro','Tipo','Entrada','Prazo','SRC','Score','Status'
  ]);

  getOrCreateSheet_(ss, SHEET_CLICKS, [
    'Timestamp','SRC','Tipo','Bairro','Entrada','Prazo','Página','UA'
  ]);

  getOrCreateSheet_(ss, SHEET_VISITS, [
    'Timestamp','SRC','Página','UA'
  ]);

  const cfg = getOrCreateSheet_(ss, SHEET_CONFIG, ['Chave','Valor']);
  if (cfg.getLastRow() === 1) {
    cfg.appendRow(['EMAIL_RELATORIO', Session.getActiveUser().getEmail() || 'seu-email@dominio.com']);
  }
}

/** =======================
 *  2) NORMALIZAÇÃO DADOS
 *  ======================= */
function normStr_(v, maxLen) {
  const s = String(v ?? '').trim();
  if (!maxLen) return s;
  return s.slice(0, maxLen);
}

function normalizeLead_(payload) {
  const p = payload || {};
  return {
    nome: normStr_(p.nome || p.name, 120),
    whatsapp: normStr_(p.whatsapp || p.phone || p.telefone, 40),
    bairro: normStr_(p.bairro || p.neighborhood, 80),
    tipo: normStr_(p.tipo || p.tipo_imovel || p.type, 40),
    entrada: normStr_(p.entrada || p.downpayment, 60),
    prazo: normStr_(p.prazo || p.timeline, 60),
    src: normStr_(p.src || p.source || 'SITE', 80),
  };
}

function normalizeClick_(payload) {
  const p = payload || {};
  return {
    src: normStr_(p.src || p.source || 'SITE', 80),
    tipo: normStr_(p.tipo || '', 40),
    bairro: normStr_(p.bairro || '', 80),
    entrada: normStr_(p.entrada || '', 60),
    prazo: normStr_(p.prazo || '', 60),
    page: normStr_(p.page || p.pagina || '', 300),
    ua: normStr_(p.ua || '', 300),
  };
}

function normalizeVisit_(payload) {
  const p = payload || {};
  return {
    src: normStr_(p.src || p.source || 'SITE', 80),
    page: normStr_(p.page || p.pagina || '', 300),
    ua: normStr_(p.ua || '', 300),
  };
}

/** =======================
 *  3) SCORE / CLASSIFICAÇÃO
 *  ======================= */
function scoreLead_(lead) {
  let score = 10;

  const prazoScore = {
    'imediato': 35,
    'até 3 meses': 30,
    'ate 3 meses': 30,
    'até 6 meses': 25,
    'ate 6 meses': 25,
    'até 12 meses': 15,
    'ate 12 meses': 15,
    'acima de 12 meses': 5
  };
  score += prazoScore[(lead.prazo || '').toLowerCase()] || 0;

  const entrada = (lead.entrada || '').toLowerCase();
  if (entrada.includes('acima de r$ 100')) score += 30;
  else if (entrada.includes('50 mil') || entrada.includes('50.000')) score += 24;
  else if (entrada.includes('20 mil') || entrada.includes('20.000')) score += 16;
  else if (entrada.includes('até r$ 10') || entrada.includes('ate r$ 10')) score += 8;

  const tipo = (lead.tipo || '').toLowerCase();
  if (tipo.includes('pronto')) score += 20;
  else if (tipo.includes('obra')) score += 14;
  else if (tipo.includes('lanç') || tipo.includes('lanc')) score += 10;

  const bairro = (lead.bairro || '').toLowerCase();
  if (['morumbi','santo amaro','butantã','butanta','vila sônia','vila sonia','vila andrade']
    .some(b => bairro.includes(b))) {
    score += 5;
  }

  return Math.max(0, Math.min(100, score));
}

function classify_(score) {
  if (score >= 75) return 'QUENTE';
  if (score >= 45) return 'MORNO';
  return 'FRIO';
}

/** =======================
 *  4) WEB APP ENDPOINTS
 *  ======================= */
function doPost(e) {
  const ss = getSpreadsheet_();
  setupSheets_(ss);

  const body = parseBody_(e) || {};
  const typeRaw = normStr_(body.type || '', 20).toLowerCase();
  const payload = body.payload || body;

  // inferência quando não vem type
  let type = typeRaw;
  if (!type) {
    if (payload && (payload.nome || payload.whatsapp)) type = 'lead';
    else if (payload && (payload.page || payload.ua) && (payload.src || payload.source)) type = 'pageview';
    else type = 'wa_click';
  }

  if (type === 'pageview') {
    const v = normalizeVisit_(payload);
    ss.getSheetByName(SHEET_VISITS).appendRow([new Date(), v.src, v.page, v.ua]);
    return json_({ ok: true });
  }

  if (type === 'lead') {
    const lead = normalizeLead_(payload);
    const score = scoreLead_(lead);
    const status = classify_(score);

    ss.getSheetByName(SHEET_LEADS).appendRow([
      new Date(),
      lead.nome,
      lead.whatsapp,
      lead.bairro,
      lead.tipo,
      lead.entrada,
      lead.prazo,
      lead.src,
      score,
      status
    ]);

    return json_({ ok: true, score, status });
  }

  if (type === 'wa_click') {
    const click = normalizeClick_(payload);
    ss.getSheetByName(SHEET_CLICKS).appendRow([
      new Date(),
      click.src,
      click.tipo,
      click.bairro,
      click.entrada,
      click.prazo,
      click.page,
      click.ua
    ]);
    return json_({ ok: true });
  }

  return json_({ ok: false, error: 'type inválido. Use lead, wa_click ou pageview.' });
}

function doGet(e) {
  const ss = getSpreadsheet_();
  setupSheets_(ss);

  const p = (e && e.parameter) ? e.parameter : {};
  const event = normStr_(p.event || '', 20).toLowerCase();

  // TESTE de VISIT via GET:
  // .../exec?event=visit&src=TESTE&page=/vip/&ua=EDGE
  if (event === 'visit') {
    const v = normalizeVisit_(p);
    ss.getSheetByName(SHEET_VISITS).appendRow([new Date(), v.src, v.page, v.ua]);
    return ContentService.createTextOutput('OK VISIT').setMimeType(ContentService.MimeType.TEXT);
  }

  // Fallback: registra clique via GET
  const click = normalizeClick_(p);
  ss.getSheetByName(SHEET_CLICKS).appendRow([
    new Date(),
    click.src,
    click.tipo,
    click.bairro,
    click.entrada,
    click.prazo,
    click.page,
    click.ua
  ]);

  return ContentService.createTextOutput('OK').setMimeType(ContentService.MimeType.TEXT);
}

/** =======================
 *  5) RELATÓRIOS E GATILHOS
 *  ======================= */
function getReportEmail_(ss) {
  const sh = ss.getSheetByName(SHEET_CONFIG);
  const data = sh.getDataRange().getValues();
  const row = data.find(r => r[0] === 'EMAIL_RELATORIO');
  return (row && row[1]) || Session.getActiveUser().getEmail();
}

function countBy_(rows, idx) {
  return rows.reduce((acc, row) => {
    const key = row[idx] || 'N/A';
    acc[key] = (acc[key] || 0) + 1;
    return acc;
  }, {});
}

function topN_(obj, n) {
  return Object.fromEntries(
    Object.entries(obj).sort((a,b) => b[1] - a[1]).slice(0, n)
  );
}

function formatMap_(obj) {
  const entries = Object.entries(obj || {});
  if (!entries.length) return '- sem dados';
  return entries.map(([k,v]) => `- ${k}: ${v}`).join('\n');
}

function sendDailyReport() {
  const ss = getSpreadsheet_();
  setupSheets_(ss);

  const today = Utilities.formatDate(new Date(), TZ, 'yyyy-MM-dd');

  const clicks = ss.getSheetByName(SHEET_CLICKS).getDataRange().getValues();
  const leads  = ss.getSheetByName(SHEET_LEADS).getDataRange().getValues();

  const clickRows = clicks.slice(1).filter(r =>
    Utilities.formatDate(new Date(r[0]), TZ, 'yyyy-MM-dd') === today
  );

  const leadRows = leads.slice(1).filter(r =>
    Utilities.formatDate(new Date(r[0]), TZ, 'yyyy-MM-dd') === today
  );

  const bySrc = countBy_(clickRows, 1);
  const byStatus = countBy_(leadRows, 9);
  const byBairro = topN_(countBy_(leadRows, 3), 5);
  const byTipo = topN_(countBy_(leadRows, 4), 5);

  const body = [
    `VIP Autopiloto - Relatório diário (${today})`,
    '',
    'Cliques no WhatsApp por origem (SRC):',
    formatMap_(bySrc),
    '',
    'Leads por status:',
    formatMap_(byStatus),
    '',
    'Top bairros (leads):',
    formatMap_(byBairro),
    '',
    'Top tipos (leads):',
    formatMap_(byTipo)
  ].join('\n');

  MailApp.sendEmail(getReportEmail_(ss), `VIP Autopiloto - Relatório diário ${today}`, body);
}

function sendFinal14DaysReport() {
  const ss = getSpreadsheet_();
  setupSheets_(ss);

  const leads  = ss.getSheetByName(SHEET_LEADS).getDataRange().getValues().slice(1);
  const clicks = ss.getSheetByName(SHEET_CLICKS).getDataRange().getValues().slice(1);

  const since = new Date();
  since.setDate(since.getDate() - 14);

  const leadRows = leads.filter(r => new Date(r[0]) >= since);
  const clickRows = clicks.filter(r => new Date(r[0]) >= since);

  const avgScore = leadRows.length
    ? (leadRows.reduce((acc, r) => acc + Number(r[8] || 0), 0) / leadRows.length).toFixed(1)
    : 0;

  const byStatus = countBy_(leadRows, 9);
  const byBairro = topN_(countBy_(leadRows, 3), 5);
  const byTipo = topN_(countBy_(leadRows, 4), 5);
  const bySrc = topN_(countBy_(clickRows, 1), 8);

  const body = [
    'VIP Autopiloto - Relatório final (14 dias)',
    '',
    `Leads totais: ${leadRows.length}`,
    `Cliques WhatsApp totais: ${clickRows.length}`,
    `Score médio: ${avgScore}`,
    '',
    'Leads por status:',
    formatMap_(byStatus),
    '',
    'Top bairros:',
    formatMap_(byBairro),
    '',
    'Top tipos:',
    formatMap_(byTipo),
    '',
    'Top origens (SRC):',
    formatMap_(bySrc)
  ].join('\n');

  MailApp.sendEmail(getReportEmail_(ss), 'VIP Autopiloto - Relatório final 14 dias', body);
}

function installTriggers() {
  ScriptApp.getProjectTriggers().forEach(t => ScriptApp.deleteTrigger(t));

  ScriptApp.newTrigger('sendDailyReport')
    .timeBased()
    .everyDays(1)
    .atHour(20)
    .nearMinute(30)
    .inTimezone(TZ)
    .create();

  ScriptApp.newTrigger('sendFinal14DaysReport')
    .timeBased()
    .everyDays(14)
    .atHour(20)
    .nearMinute(30)
    .inTimezone(TZ)
    .create();
}

/** =======================
 *  6) SETUP INICIAL
 *  ======================= */
function salvarIdDaPlanilha() {
  const id = SpreadsheetApp.getActiveSpreadsheet().getId();
  PropertiesService.getScriptProperties().setProperty(PROP_SPREADSHEET_ID, id);
  Logger.log('SPREADSHEET_ID salvo: ' + id);
}
